// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// Main Schema (01_main.sql) - Athletes, Tokens, Sessions
// ============================================================================

model Athlete {
  id                BigInt     @id @default(autoincrement())
  athleteId         BigInt     @unique @map("athlete_id")
  username          String?    @db.VarChar(255)
  firstname         String     @db.VarChar(255)
  lastname          String?    @db.VarChar(255)
  email             String?    @db.VarChar(255)
  city              String?    @db.VarChar(255)
  country           String?    @db.VarChar(255)
  profilePicture    String?    @map("profile_picture") @db.Text
  accessTokenHash   String?    @map("access_token_hash") @db.VarChar(64)
  stravaCreatedAt   DateTime?  @map("strava_created_at") @db.Timestamp()
  stravaUpdatedAt   DateTime?  @map("strava_updated_at") @db.Timestamp()
  connectedAt       DateTime   @default(now()) @map("connected_at") @db.Timestamp()
  lastSeenAt        DateTime?  @map("last_seen_at") @db.Timestamp()
  isActive          Boolean    @default(true) @map("is_active")
  createdAt         DateTime   @default(now()) @map("created_at") @db.Timestamp()
  updatedAt         DateTime   @default(now()) @updatedAt @map("updated_at") @db.Timestamp()
  
  // Relations
  tokens            Token[]
  userSessions      UserSession[]
  authEvents        AuthEvent[]
  downloads         Download[]
  visits            Visit[]

  @@index([athleteId], name: "idx_athletes_athlete_id")
  @@index([email], name: "idx_athletes_email")
  @@index([isActive], name: "idx_athletes_active")
  @@map("athletes")
}

model Token {
  id            BigInt    @id @default(autoincrement())
  athleteId     BigInt    @map("athlete_id")
  accessToken   String    @map("access_token") @db.Text
  refreshToken  String?   @map("refresh_token") @db.Text
  expiresAt     DateTime? @map("expires_at") @db.Timestamp()
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamp()
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamp()
  
  // Relations
  athlete       Athlete   @relation(fields: [athleteId], references: [athleteId], onDelete: Cascade)
  
  @@index([athleteId], name: "idx_tokens_athlete_id")
  @@map("tokens")
}

model UserSession {
  id           BigInt    @id @default(autoincrement())
  athleteId    BigInt    @map("athlete_id")
  sessionToken String    @unique @map("session_token") @db.VarChar(255)
  ipAddress    String?   @map("ip_address") @db.VarChar(45)
  userAgent    String?   @map("user_agent") @db.Text
  expiresAt    DateTime  @map("expires_at") @db.Timestamp()
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamp()
  
  // Relations
  athlete      Athlete   @relation(fields: [athleteId], references: [athleteId], onDelete: Cascade)
  
  @@index([athleteId], name: "idx_sessions_athlete_id")
  @@index([sessionToken], name: "idx_sessions_token")
  @@index([expiresAt], name: "idx_sessions_expires_at")
  @@map("user_sessions")
}

// ============================================================================
// Admin Schema (02_admin.sql) - Clubs, Templates
// ============================================================================

model Club {
  id          String    @id @db.VarChar(255)
  name        String    @db.VarChar(255)
  slug        String    @unique @db.VarChar(255)
  description String?   @db.Text
  logoAssetId String?   @map("logo_asset_id") @db.VarChar(255)
  theme       Json      @default("{}") @db.JsonB
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamp()
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamp()
  status      String    @default("active") @db.VarChar(50)
  
  // Relations
  templates   Template[]
  
  @@index([slug], name: "idx_clubs_slug")
  @@index([status], name: "idx_clubs_status")
  @@map("clubs")
}

model Template {
  id          String   @id @db.VarChar(255)
  clubId      String?  @map("club_id") @db.VarChar(255)
  name        String   @db.VarChar(255)
  description String?  @db.Text
  tags        Json     @default("[]") @db.JsonB
  pages       Json     @default("[]") @db.JsonB
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp()
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp()
  version     Int      @default(1)
  status      String   @default("draft") @db.VarChar(50)
  
  // Relations
  club        Club?    @relation(fields: [clubId], references: [id], onDelete: Cascade)
  
  @@index([clubId], name: "idx_templates_club_id")
  @@index([status], name: "idx_templates_status")
  @@index([updatedAt], name: "idx_templates_updated_at")
  @@map("templates")
}

// ============================================================================
// Analytics Schema (03_analytics.sql) - Events, Downloads, Visits
// ============================================================================

model AuthEvent {
  id         BigInt    @id @default(autoincrement())
  athleteId  BigInt?   @map("athlete_id")
  ipAddress  String?   @map("ip_address") @db.VarChar(45)
  userAgent  String?   @map("user_agent") @db.Text
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamp()
  
  // Relations
  athlete    Athlete?  @relation(fields: [athleteId], references: [athleteId], onDelete: SetNull)
  
  @@index([athleteId], name: "idx_auth_events_athlete_id")
  @@index([createdAt], name: "idx_auth_events_created_at")
  @@map("auth_events")
}

model Download {
  id         BigInt    @id @default(autoincrement())
  athleteId  BigInt?   @map("athlete_id")
  clubId     String?   @map("club_id") @db.VarChar(50)
  ipAddress  String?   @map("ip_address") @db.VarChar(45)
  userAgent  String?   @map("user_agent") @db.Text
  fileFormat String?   @map("file_format") @db.VarChar(10)
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamp()
  
  // Relations
  athlete    Athlete?  @relation(fields: [athleteId], references: [athleteId], onDelete: SetNull)
  
  @@index([athleteId], name: "idx_downloads_athlete_id")
  @@index([clubId], name: "idx_downloads_club_id")
  @@index([createdAt], name: "idx_downloads_created_at")
  @@map("downloads")
}

model Visit {
  id         BigInt    @id @default(autoincrement())
  sessionId  String?   @map("session_id") @db.VarChar(255)
  athleteId  BigInt?   @map("athlete_id")
  clubId     String?   @map("club_id") @db.VarChar(50)
  ipAddress  String?   @map("ip_address") @db.VarChar(45)
  userAgent  String?   @map("user_agent") @db.Text
  pagePath   String?   @map("page_path") @db.VarChar(255)
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamp()
  
  // Relations
  athlete    Athlete?  @relation(fields: [athleteId], references: [athleteId], onDelete: SetNull)
  
  @@index([sessionId], name: "idx_visits_session_id")
  @@index([athleteId], name: "idx_visits_athlete_id")
  @@index([clubId], name: "idx_visits_club_id")
  @@index([createdAt], name: "idx_visits_created_at")
  @@map("visits")
}
