# Решение проблемы билда на Railway

## Проблема

Railway использует внутренний URL для DATABASE_URL:
```
postgresql://postgres:password@postgres-ozrq.railway.internal:5432/railway
```

Этот URL **недоступен во время билда**, так как билд происходит в отдельном контейнере без доступа к внутренней сети Railway.

## Решение

### Изменения в `lib/db.ts`

1. **Определение фазы билда:**
   - Проверяет `NEXT_PHASE` (устанавливается Next.js)
   - Проверяет наличие Railway internal URL во время production билда
   - Определяет, что мы в билде, а не в runtime

2. **Использование placeholder URL:**
   - Если обнаружен Railway internal URL во время билда → использует placeholder
   - Позволяет Prisma Client сгенерироваться без подключения к БД

3. **Отключение подключений во время билда:**
   - Переопределяет `$connect()` метод
   - Предотвращает попытки подключения к БД во время билда

### Изменения в `next.config.ts`

- Добавлен `output: 'standalone'` для правильной работы в Railway
- Это гарантирует, что API routes не статически генерируются

## Как это работает

### Во время билда на Railway:

1. Код определяет, что `DATABASE_URL` содержит `railway.internal`
2. Определяет, что мы в фазе билда (не в runtime)
3. Использует placeholder URL: `postgresql://placeholder:...`
4. Prisma Client генерируется успешно
5. Все попытки подключения к БД игнорируются
6. Билд проходит успешно ✅

### Во время выполнения на Railway:

1. Код определяет, что мы в runtime (не в билде)
2. Использует реальный `DATABASE_URL` с Railway internal URL
3. Prisma подключается к БД нормально
4. Все работает как ожидается ✅

## Проверка

После применения исправлений:

1. ✅ Локальный билд проходит успешно
2. ✅ Код правильно определяет фазу билда
3. ✅ Placeholder URL используется во время билда
4. ✅ Реальный URL используется во время выполнения

## Деплой на Railway

1. Закоммитьте изменения
2. Запустите новый деплой на Railway
3. Билд должен пройти успешно
4. После деплоя приложение подключится к БД

## Если проблема сохраняется

Проверьте логи билда в Railway Dashboard:
- Найдите конкретную ошибку
- Убедитесь, что все переменные окружения установлены
- Проверьте, что `DATABASE_URL` содержит `railway.internal`

Если ошибка все еще есть, возможно нужно:
1. Использовать внешний URL для DATABASE_URL (если доступен)
2. Или настроить Railway для использования внешнего URL во время билда

Но текущее решение должно работать для большинства случаев.

