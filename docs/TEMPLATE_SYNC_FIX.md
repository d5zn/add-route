# Исправление несоответствия шаблонов между основным приложением и админкой

## Проблема

**Симптомы:**
- В основном приложении у клуба NOT IN PARIS видно 3 шаблона: Classic Route, Mono Cut, Sunset Fade
- В админке для того же клуба показывается 1 опубликованный и 2 черновика
- Шаблоны не совпадают между приложениями

## Причина

Основное приложение (`app-addicted-logic.js`) использует **фолбэк-шаблоны** (hardcoded), когда:
1. API не возвращает шаблоны из базы данных
2. API возвращает пустой массив
3. Произошла ошибка при загрузке

Админка показывает реальные данные из базы данных.

### Архитектура загрузки шаблонов

```
┌─────────────────────────────────────────────────────────────────┐
│ Основное приложение (app-addicted-logic.js)                     │
│                                                                  │
│  1. Пытается загрузить: GET /api/templates?clubId=not-in-paris  │
│  2. Если успешно → использует шаблоны из БД                      │
│  3. Если ошибка/пусто → использует ФОЛБЭК-ШАБЛОНЫ (hardcoded)   │
│                                                                  │
│  Фолбэк для NOT IN PARIS:                                        │
│    - Classic Route  (id: nip-classic)                            │
│    - Mono Cut       (id: nip-mono)                               │
│    - Sunset Fade    (id: nip-gradient)                           │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ Админка (React)                                                  │
│                                                                  │
│  1. Загружает: GET /route/admin/api/templates?clubId=...        │
│  2. Показывает ТОЛЬКО данные из БД                               │
│  3. Показывает все статусы: draft, published, archived           │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ API для основного приложения                                     │
│  GET /api/templates?clubId=X                                     │
│  → Возвращает ТОЛЬКО published шаблоны                           │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ API для админки                                                  │
│  GET /route/admin/api/templates?clubId=X                         │
│  → Возвращает ВСЕ шаблоны (кроме deleted)                        │
└─────────────────────────────────────────────────────────────────┘
```

## Решение

### Вариант 1: Синхронизировать фолбэк-шаблоны с БД (Рекомендуется)

Импортировать фолбэк-шаблоны в базу данных как published, чтобы они были доступны и в админке.

**Шаги:**

1. Убедитесь, что DATABASE_URL установлена:
   ```bash
   # Локально
   export DATABASE_URL="postgresql://user:password@host:port/database"
   
   # На Railway (уже должна быть установлена)
   # Проверить: echo $DATABASE_URL
   ```

2. Запустите скрипт синхронизации:
   ```bash
   python3 sync_fallback_templates.py
   ```

3. Скрипт:
   - Проверит существующие шаблоны в БД
   - Создаст фолбэк-шаблоны, если их нет
   - Изменит статус существующих на `published`, если они были `draft`
   - Покажет итоговую статистику

4. Обновите приложения:
   - Откройте основное приложение и нажмите Ctrl+Shift+R (hard refresh)
   - Откройте админку и нажмите Ctrl+Shift+R
   - Теперь шаблоны должны совпадать

### Вариант 2: Удалить фолбэк-шаблоны из кода

Если вы хотите, чтобы основное приложение показывало ТОЛЬКО шаблоны из БД:

1. Измените `app-addicted-logic.js`:
   ```javascript
   async loadTemplates() {
       const clubId = this.currentClub || 'not-in-paris';
       
       try {
           const response = await fetch(`/api/templates?clubId=${encodeURIComponent(clubId)}`);
           if (response.ok) {
               const data = await response.json();
               this.templatesByClub[clubId] = data.templates || [];
               console.log(`✅ Loaded ${data.templates.length} templates from API`);
               return;
           }
       } catch (error) {
           console.error('Failed to load templates from API:', error);
       }
       
       // Не используем fallback - показываем пустой список
       this.templatesByClub[clubId] = [];
   }
   ```

2. Удалите или закомментируйте метод `getTemplateDefinitions()`

3. Создайте шаблоны через админку и опубликуйте их

**Минусы:** Если БД недоступна или пуста, пользователи не увидят шаблоны.

### Вариант 3: Опубликовать существующие черновики в админке

Если в админке уже есть нужные шаблоны, но они в статусе `draft`:

1. Откройте админку: `https://your-domain.railway.app/route/admin`
2. Войдите (admin / ваш_пароль)
3. Выберите клуб NOT IN PARIS
4. Откройте каждый шаблон
5. Измените статус на `published`
6. Сохраните

**Проблема:** Если в админке другие шаблоны (не Classic Route, Mono Cut, Sunset Fade), пользователи увидят их вместо ожидаемых.

## Проверка

После применения решения проверьте:

1. **Основное приложение:**
   - Откройте `/route/`
   - Подключитесь к Strava
   - Выберите клуб NOT IN PARIS
   - Выберите тренировку
   - Проверьте список шаблонов

2. **Админка:**
   - Откройте `/route/admin`
   - Войдите
   - Выберите клуб NOT IN PARIS
   - Проверьте список шаблонов
   - Убедитесь, что статусы правильные

3. **API:**
   ```bash
   # Проверить, что возвращает API для основного приложения
   curl "https://your-domain.railway.app/api/templates?clubId=not-in-paris"
   
   # Должен вернуть JSON с published шаблонами
   ```

## Скрипты

### `sync_fallback_templates.py`

Синхронизирует фолбэк-шаблоны из `app-addicted-logic.js` с базой данных.

**Что делает:**
- Импортирует все фолбэк-шаблоны (Classic Route, Mono Cut, Sunset Fade для NOT IN PARIS)
- Создает их в БД, если их нет
- Устанавливает статус `published`
- Сохраняет ID из кода (nip-classic, nip-mono, nip-gradient)

**Использование:**
```bash
# Локально
export DATABASE_URL="postgresql://..."
python3 sync_fallback_templates.py

# На Railway
railway run python3 sync_fallback_templates.py
```

### `check_templates.py`

Проверяет текущее состояние шаблонов в БД.

**Использование:**
```bash
python3 check_templates.py
```

## Рекомендации

1. **Используйте Вариант 1** (синхронизация) - это самый надежный способ
2. После синхронизации создавайте новые шаблоны через админку
3. Всегда публикуйте шаблоны (меняйте статус на `published`)
4. Периодически проверяйте, что оба приложения показывают одинаковые шаблоны

## Будущие улучшения

1. Добавить автоматическую синхронизацию при деплое
2. Добавить в админку кнопку "Import Fallback Templates"
3. Добавить валидацию: предупреждать, если нет published шаблонов
4. Добавить индикатор в основном приложении: "Loading templates from database..." vs "Using fallback templates"

## См. также

- `/docs/CLUBS_SYNC.md` - Синхронизация клубов
- `/docs/SYNC_CHANGES.md` - История изменений синхронизации
- `/docs/API_ENDPOINTS.md` - Документация API

